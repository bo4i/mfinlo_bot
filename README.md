# Бот технической поддержки Министерства финансов Липецкой области

Телеграм-бот для приёма и маршрутизации заявок в ИТ и АХО для Министерства финансов Липецкой области. Построен на [aiogram 3](https://docs.aiogram.dev/) и использует SQLAlchemy для хранения пользователей, администраторов и заявок.

## Возможности
- Регистрация с ФИО, телефоном, организацией и кабинетом (для требующих этого организаций).
- Создание ИТ- и АХО-заявок с вложениями, указанием срочности (срочно или к дате/времени) и резюме перед отправкой.
- Поддержка уточнений между пользователем и администратором: вопросы можно задать в карточке заявки, диалог завершается кнопкой «Завершить уточнение».
- Раздел «Мои заявки» для отслеживания статусов, исполнителей и времени создания/закрытия.
- Кнопки администратора для принятия, запроса уточнений, отказа и закрытия заявки; уведомления отправляются в профильные чаты ИТ и АХО.
- Специальная логика АХО-брони автомобиля: проверка пересечений по времени и автоматическое добавление деталей поездки в описание.
- Автоматическое создание таблиц БД и заполнение списка администраторов при старте.

## Требования
- Python 3.11+
- Telegram Bot API токен

## Установка
1. Клонируйте репозиторий и перейдите в его папку:
   ```bash
   git clone <repo-url>
   cd mfinlo_bot
   ```
2. Создайте и активируйте виртуальное окружение (опционально, но рекомендовано):
   ```bash
   python -m venv .venv
   source .venv/bin/activate
   ```
3. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

## Настройка
1. Создайте файл `.env` в корне проекта и укажите переменные:
   ```
   BOT_TOKEN=<ваш_токен_бота>
   DATABASE_URL=sqlite:///./bot.db  # опционально, значение по умолчанию
   ```
2. При необходимости измените параметры в `app/config.py`:
   - `IT_ADMIN_IDS` и `AHO_ADMIN_IDS` — списки Telegram ID администраторов профильных направлений.
   - `PREDEFINED_ORGANIZATIONS` и `ORGANIZATIONS_NEEDING_OFFICE_NUMBER` — готовый список организаций и тех, где нужно вводить кабинет.
При первом запуске таблицы создаются автоматически. По умолчанию используется SQLite-файл `bot.db` в корне проекта, но можно подключить PostgreSQL или другую СУБД через `DATABASE_URL`.
## Запуск
Запустите бота командой:
```bash
python main.py
```
После старта бот начнёт опрос Telegram. Для первого использования выполните в чате команду `/start` и пройдите регистрацию.

## Структура проекта
- `main.py` — точка входа, настройка диспетчера и запуск опроса.
- `app/config.py` — конфигурация токена, базы данных и списков администраторов/организаций.
- `app/db` — подключение к базе, модели SQLAlchemy и утилиты для сессий.
- `app/routers` — хендлеры aiogram для регистрации, заявок и административных действий.
- `app/services/startup.py` — инициализация администраторов при старте.
- `app/keyboards` и `app/states` — разметка клавиатур и определения состояний FSM.


## Дополнительные материалы
- `docs/Руководство_пользователя.md` — шаги регистрации, создания заявки, работы с уточнениями и разделом «Мои заявки».
- `docs/Руководство_администратора.md` — как принимать, уточнять и закрывать заявки, особенности бронирования автомобиля.

## Полезные советы
- При изменении `DATABASE_URL` не забудьте перенести существующую базу или пересоздать таблицы.
- Для тестирования уведомлений добавьте свой Telegram ID в списки администраторов и перезапустите бота.
